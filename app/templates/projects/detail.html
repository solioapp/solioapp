{% extends "base.html" %}

{% block title %}{{ project.title }} - Solio{% endblock %}
{% block description %}{{ project.description|striptags|truncate(160) }}{% endblock %}

{% block og_type %}article{% endblock %}
{% block og_title %}{{ project.title }} - Support on Solio{% endblock %}
{% block og_description %}{{ project.description|striptags|truncate(200) }}{% endblock %}
{% block og_image %}{% if project.images and project.images|length > 0 %}{{ project.images[0] }}{% else %}{{ url_for('static', filename='images/og-default.png', _external=True) }}{% endif %}{% endblock %}

{% block twitter_title %}{{ project.title }} - Support on Solio{% endblock %}
{% block twitter_description %}{{ project.description|striptags|truncate(200) }}{% endblock %}
{% block twitter_image %}{% if project.images and project.images|length > 0 %}{{ project.images[0] }}{% else %}{{ url_for('static', filename='images/og-default.png', _external=True) }}{% endif %}{% endblock %}

{% block content %}
<div class="project-detail">
    {% if project.is_draft %}
    <div class="draft-banner">
        <div class="container">
            <div class="draft-banner-content">
                <span class="draft-badge">DRAFT</span>
                <p>This project is not yet published and is only visible to you.</p>
                <form action="{{ url_for('projects.publish', id=project.id) }}" method="POST" class="inline-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-primary btn-sm">Publish Now</button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="container">
        <div class="project-grid">
            <!-- Main Content -->
            <div class="project-main">
                <!-- Gallery -->
                <div class="project-gallery">
                    {% if project.images and project.images|length > 0 %}
                        <div class="gallery-main">
                            <img src="{{ project.images[0] }}" alt="{{ project.title }}" id="galleryMainImage">
                        </div>
                        {% if project.images|length > 1 %}
                            <div class="gallery-thumbs">
                                {% for image in project.images %}
                                    <button class="gallery-thumb {{ 'active' if loop.first }}"
                                            data-image="{{ image }}">
                                        <img src="{{ image }}" alt="Image {{ loop.index }}">
                                    </button>
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="gallery-placeholder">
                            <span class="placeholder-icon">◈</span>
                        </div>
                    {% endif %}
                </div>

                <!-- Video -->
                {% if project.video_url %}
                    <div class="project-video">
                        <div class="video-container">
                            <iframe src="{{ project.video_url|replace('watch?v=', 'embed/') }}"
                                    frameborder="0"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                    allowfullscreen></iframe>
                        </div>
                    </div>
                {% endif %}

                <!-- Description -->
                <div class="project-description">
                    <h2>About the Project</h2>
                    <div class="description-content">
                        {{ project.description|safe }}
                    </div>
                </div>

                <!-- Milestones -->
                {% if milestones %}
                    <div class="project-milestones">
                        <h2>Milestones</h2>
                        <div class="milestones-list">
                            {% for milestone in milestones %}
                                <div class="milestone {{ 'reached' if milestone.reached }}">
                                    <div class="milestone-marker">
                                        {% if milestone.reached %}
                                            <svg viewBox="0 0 24 24" width="20" height="20">
                                                <path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                            </svg>
                                        {% else %}
                                            <span>{{ "%.1f"|format(milestone.amount_sol|float) }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="milestone-content">
                                        <h4>{{ milestone.title }}</h4>
                                        <p class="milestone-amount">{{ "%.2f"|format(milestone.amount_sol|float) }} SOL</p>
                                        {% if milestone.description %}
                                            <p class="milestone-desc">{{ milestone.description }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                <!-- Project Updates -->
                <div class="updates-preview">
                    <div class="updates-preview-header">
                        <h2>Updates <span class="count">({{ project.updates.count() }})</span></h2>
                        {% if current_user.is_authenticated and current_user.id == project.user_id %}
                            <a href="{{ url_for('projects.create_update', id=project.id) }}" class="btn btn-sm btn-outline">+ Post Update</a>
                        {% endif %}
                    </div>
                    {% set latest_updates = project.updates.limit(3).all() %}
                    {% if latest_updates %}
                        {% for update in latest_updates %}
                            <div class="update-preview-item">
                                <h4>{{ update.title }}</h4>
                                <div class="update-date">
                                    <svg viewBox="0 0 24 24" width="14" height="14">
                                        <path fill="currentColor" d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/>
                                    </svg>
                                    {{ update.created_at.strftime('%B %d, %Y') }}
                                </div>
                                <div class="update-excerpt">{{ update.content|striptags|truncate(200) }}</div>
                            </div>
                        {% endfor %}
                        {% if project.updates.count() > 3 %}
                            <a href="{{ url_for('projects.list_updates', id=project.id) }}" class="btn btn-outline btn-sm">View All Updates</a>
                        {% endif %}
                    {% else %}
                        <p class="text-muted">No updates yet.</p>
                    {% endif %}
                </div>

                <!-- Donations List -->
                <div class="project-donations">
                    <h2>Donors <span class="count">({{ project.donation_count }})</span></h2>
                    {% if donations %}
                        <div class="donations-list">
                            {% for donation in donations %}
                                <div class="donation-item">
                                    <div class="donation-avatar">
                                        {% if donation.donor and donation.donor.profile_image %}
                                            <img src="{{ donation.donor.profile_image }}" alt="{{ donation.donor_display_name }}">
                                        {% else %}
                                            <div class="avatar-placeholder">
                                                {{ donation.donor_display_name[0].upper() }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="donation-info">
                                        <div class="donation-header">
                                            <span class="donor-name">{{ donation.donor_display_name }}</span>
                                            <span class="donation-amount">{{ "%.4f"|format(donation.amount_sol|float) }} SOL</span>
                                        </div>
                                        {% if donation.message %}
                                            <p class="donation-message">{{ donation.message }}</p>
                                        {% endif %}
                                        <div class="donation-meta">
                                            <span class="donation-time">{{ donation.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                            <a href="{{ donation.explorer_url }}" target="_blank" class="tx-link">
                                                Transaction ↗
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="no-donations">No donations yet. Be the first!</p>
                    {% endif %}
                </div>

                <!-- Comments Section -->
                <div class="project-comments">
                    <h2>Discussion <span class="count">({{ project.comments.filter_by(parent_id=None).count() }})</span></h2>

                    {% if current_user.is_authenticated %}
                    <form action="{{ url_for('projects.add_comment', id=project.id) }}" method="POST" class="comment-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="comment-input-wrapper">
                            {% if current_user.profile_image %}
                                <img src="{{ current_user.profile_image }}" alt="{{ current_user.username }}" class="comment-avatar">
                            {% else %}
                                <div class="comment-avatar-placeholder">{{ current_user.username[0].upper() }}</div>
                            {% endif %}
                            <textarea name="content" placeholder="Add a comment..." rows="2" required maxlength="2000"></textarea>
                        </div>
                        <div class="comment-form-actions">
                            <button type="submit" class="btn btn-primary btn-sm">Post Comment</button>
                        </div>
                    </form>
                    {% else %}
                    <p class="login-prompt">
                        <a href="{{ url_for('auth.login') }}">Log in</a> to join the discussion.
                    </p>
                    {% endif %}

                    <div class="comments-list" id="commentsList">
                        {% for comment in top_comments %}
                        <div class="comment-item" data-comment-id="{{ comment.id }}">
                            <div class="comment-avatar">
                                {% if comment.author.profile_image %}
                                    <img src="{{ comment.author.profile_image }}" alt="{{ comment.author.username }}">
                                {% else %}
                                    <div class="avatar-placeholder">{{ comment.author.username[0].upper() }}</div>
                                {% endif %}
                            </div>
                            <div class="comment-content">
                                <div class="comment-header">
                                    <span class="comment-author">{{ comment.author.username }}</span>
                                    <span class="comment-time">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                    {% if current_user.is_authenticated and (current_user.id == comment.user_id or current_user.id == project.user_id or current_user.is_admin) %}
                                    <form action="{{ url_for('projects.delete_comment', id=project.id, cid=comment.id) }}" method="POST" class="inline-form"
                                          onsubmit="return confirm('Delete this comment?')">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="comment-delete">&times;</button>
                                    </form>
                                    {% endif %}
                                </div>
                                <p class="comment-text">{{ comment.content }}</p>

                                <!-- Replies -->
                                {% if comment.replies.count() > 0 %}
                                <div class="comment-replies">
                                    {% for reply in comment.replies.order_by('created_at').all() %}
                                    <div class="comment-item reply" data-comment-id="{{ reply.id }}">
                                        <div class="comment-avatar small">
                                            {% if reply.author.profile_image %}
                                                <img src="{{ reply.author.profile_image }}" alt="{{ reply.author.username }}">
                                            {% else %}
                                                <div class="avatar-placeholder">{{ reply.author.username[0].upper() }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="comment-content">
                                            <div class="comment-header">
                                                <span class="comment-author">{{ reply.author.username }}</span>
                                                <span class="comment-time">{{ reply.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                                {% if current_user.is_authenticated and (current_user.id == reply.user_id or current_user.id == project.user_id or current_user.is_admin) %}
                                                <form action="{{ url_for('projects.delete_comment', id=project.id, cid=reply.id) }}" method="POST" class="inline-form"
                                                      onsubmit="return confirm('Delete this reply?')">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    <button type="submit" class="comment-delete">&times;</button>
                                                </form>
                                                {% endif %}
                                            </div>
                                            <p class="comment-text">{{ reply.content }}</p>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}

                                <!-- Reply form -->
                                {% if current_user.is_authenticated %}
                                <button type="button" class="reply-toggle" data-comment-id="{{ comment.id }}">Reply</button>
                                <form action="{{ url_for('projects.add_comment', id=project.id) }}" method="POST" class="reply-form" id="reply-form-{{ comment.id }}" style="display: none;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                    <textarea name="content" placeholder="Write a reply..." rows="2" required maxlength="2000"></textarea>
                                    <div class="reply-form-actions">
                                        <button type="button" class="btn btn-outline btn-sm reply-cancel">Cancel</button>
                                        <button type="submit" class="btn btn-primary btn-sm">Reply</button>
                                    </div>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}

                        {% if project.comments.filter_by(parent_id=None).count() > 20 %}
                        <a href="{{ url_for('projects.api_comments', id=project.id) }}" class="btn btn-outline load-more-comments">Load More Comments</a>
                        {% endif %}

                        {% if not top_comments %}
                        <p class="no-comments">No comments yet. Be the first to start a discussion!</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <aside class="project-sidebar">
                <div class="sidebar-sticky">
                    <!-- Progress Card -->
                    <div class="funding-card">
                        <div class="funding-amount">
                            <span class="raised">{{ "%.2f"|format(project.raised_sol|float) }}</span>
                            <span class="currency">SOL</span>
                        </div>
                        <p class="funding-goal">raised of {{ "%.2f"|format(project.goal_sol|float) }} SOL goal</p>

                        <div class="progress-bar large">
                            <div class="progress-fill" style="width: {{ [project.progress_percent, 100]|min }}%"></div>
                        </div>

                        <div class="funding-stats">
                            <div class="stat">
                                <span class="stat-value">{{ "%.0f"|format(project.progress_percent) }}%</span>
                                <span class="stat-label">funded</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value">{{ project.donation_count }}</span>
                                <span class="stat-label">donors</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" id="timeRemaining">
                                    {% if project.is_ended %}
                                        0
                                    {% else %}
                                        {{ project.time_remaining.days if project.time_remaining else 0 }}
                                    {% endif %}
                                </span>
                                <span class="stat-label">days left</span>
                            </div>
                        </div>

                        {% if project.is_active %}
                            <!-- Donation Form -->
                            <div class="donation-form">
                                <div class="form-group">
                                    <label for="donationAmount">Amount (SOL)</label>
                                    <div class="amount-input">
                                        <input type="number" id="donationAmount" step="0.001" min="0.001"
                                               placeholder="1.0" value="1">
                                        <span class="currency-label">SOL</span>
                                    </div>
                                    <p class="usd-estimate" id="usdEstimate">≈ $0.00 USD</p>
                                </div>

                                <div class="amount-presets">
                                    <button class="preset-btn" data-amount="0.1">0.1</button>
                                    <button class="preset-btn" data-amount="0.5">0.5</button>
                                    <button class="preset-btn active" data-amount="1">1</button>
                                    <button class="preset-btn" data-amount="5">5</button>
                                    <button class="preset-btn" data-amount="10">10</button>
                                </div>

                                {% if reward_tiers %}
                                <!-- Reward Tiers -->
                                <div class="reward-tiers-section">
                                    <label class="form-label">Select Reward (optional)</label>
                                    <input type="hidden" id="selectedTierId" value="">

                                    <div class="reward-tier-card no-reward selected" data-tier-id="" data-min-amount="0">
                                        <div class="tier-title">No Reward</div>
                                        <div class="tier-description">Just support this project without a reward</div>
                                    </div>

                                    {% for tier in reward_tiers %}
                                    <div class="reward-tier-card {% if not tier.is_available %}sold-out{% endif %}"
                                         data-tier-id="{{ tier.id }}"
                                         data-min-amount="{{ tier.min_amount_sol }}">
                                        <div class="tier-amount">{{ tier.min_amount_sol }} SOL+</div>
                                        <div class="tier-title">{{ tier.title }}</div>
                                        <div class="tier-description">{{ tier.description }}</div>
                                        {% if tier.max_claims %}
                                            {% if tier.is_available %}
                                            <div class="tier-availability limited">{{ tier.remaining_count }} left of {{ tier.max_claims }}</div>
                                            {% else %}
                                            <div class="tier-availability sold-out">Sold out</div>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>

                                <!-- Email for reward fulfillment -->
                                <div class="form-group" id="donorEmailGroup" style="display: none;">
                                    <label for="donorEmail">Your Email (for reward delivery) *</label>
                                    <input type="email" id="donorEmail" placeholder="your@email.com">
                                    <span class="form-hint">The creator will contact you to fulfill your reward</span>
                                </div>
                                {% endif %}

                                <div class="form-group">
                                    <label for="donationMessage">Message (optional)</label>
                                    <textarea id="donationMessage" rows="2" maxlength="500"
                                              placeholder="Write a message to the creator..."></textarea>
                                </div>

                                <div class="form-group checkbox-group donation-consent">
                                    <label class="checkbox-label small">
                                        <input type="checkbox" id="donationConsent">
                                        <span class="checkmark"></span>
                                        <span>I understand that donations are <strong>non-refundable</strong> and the platform does not guarantee fulfillment of creator's promises.</span>
                                    </label>
                                </div>

                                <button class="btn btn-primary btn-block btn-lg" id="donateBtn"
                                        data-project-id="{{ project.id }}" disabled>
                                    <svg viewBox="0 0 24 24" width="20" height="20">
                                        <path fill="currentColor" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                    </svg>
                                    Donate
                                </button>

                                <p class="donation-info">
                                    100% goes to the project. A {{ platform_fee_percent }}% fee is deducted upon payout.
                                </p>
                            </div>
                        {% else %}
                            <div class="project-ended-notice">
                                <p>This project is no longer accepting donations.</p>
                                {% if project.payout_status == 'completed' %}
                                    <p class="payout-info">
                                        Funds have been paid out.
                                        {% if project.payout_tx %}
                                            <a href="https://explorer.solana.com/tx/{{ project.payout_tx }}{{ '?cluster=devnet' if config.USE_DEVNET }}"
                                               target="_blank">View transaction ↗</a>
                                        {% endif %}
                                    </p>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Creator Card -->
                    <div class="creator-card">
                        <a href="{{ url_for('profile.public_profile', username=project.creator.username) }}" class="creator-link">
                            {% if project.creator.profile_image %}
                                <img src="{{ project.creator.profile_image }}" alt="{{ project.creator.username }}" class="creator-avatar">
                            {% else %}
                                <div class="creator-avatar-placeholder">{{ project.creator.username[0].upper() }}</div>
                            {% endif %}
                            <div class="creator-info">
                                <span class="creator-name">{{ project.creator.username }}</span>
                                <span class="creator-label">Project Creator</span>
                            </div>
                        </a>
                    </div>

                    <!-- Share Buttons -->
                    <div class="share-card">
                        <h4>Share Project</h4>
                        <div class="share-buttons">
                            <button class="share-btn" data-share="twitter" title="Share on X">
                                <svg viewBox="0 0 24 24" width="20" height="20">
                                    <path fill="currentColor" d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                                </svg>
                            </button>
                            <button class="share-btn" data-share="telegram" title="Share on Telegram">
                                <svg viewBox="0 0 24 24" width="20" height="20">
                                    <path fill="currentColor" d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                                </svg>
                            </button>
                            <button class="share-btn" data-share="copy" title="Copy link">
                                <svg viewBox="0 0 24 24" width="20" height="20">
                                    <path fill="currentColor" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Project Links -->
                    {% if project.project_website or project.project_twitter or project.project_telegram or project.project_github or project.project_discord or project.project_linkedin or project.project_youtube %}
                        <div class="project-links-card">
                            <h4>Project Links</h4>
                            <div class="project-links">
                                {% if project.project_website %}
                                    <a href="{{ project.project_website }}" target="_blank" class="project-link">
                                        <svg viewBox="0 0 24 24" width="18" height="18">
                                            <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                                        </svg>
                                        Website
                                    </a>
                                {% endif %}
                                {% if project.project_twitter %}
                                    <a href="{{ project.project_twitter }}" target="_blank" class="project-link">
                                        <svg viewBox="0 0 24 24" width="18" height="18">
                                            <path fill="currentColor" d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                                        </svg>
                                        Twitter/X
                                    </a>
                                {% endif %}
                                {% if project.project_telegram %}
                                    <a href="{{ project.project_telegram }}" target="_blank" class="project-link">
                                        <svg viewBox="0 0 24 24" width="18" height="18">
                                            <path fill="currentColor" d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                                        </svg>
                                        Telegram
                                    </a>
                                {% endif %}
                                {% if project.project_github %}
                                    <a href="{{ project.project_github }}" target="_blank" class="project-link">
                                        <svg viewBox="0 0 24 24" width="18" height="18">
                                            <path fill="currentColor" d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                        </svg>
                                        GitHub
                                    </a>
                                {% endif %}
                                {% if project.project_discord %}
                                    <a href="{{ project.project_discord }}" target="_blank" class="project-link">
                                        <svg viewBox="0 0 24 24" width="18" height="18">
                                            <path fill="currentColor" d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.9555 2.4189-2.1569 2.4189zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.4189-2.1568 2.4189Z"/>
                                        </svg>
                                        Discord
                                    </a>
                                {% endif %}
                                {% if project.project_linkedin %}
                                    <a href="{{ project.project_linkedin }}" target="_blank" class="project-link">
                                        <svg viewBox="0 0 24 24" width="18" height="18">
                                            <path fill="currentColor" d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                        </svg>
                                        LinkedIn
                                    </a>
                                {% endif %}
                                {% if project.project_youtube %}
                                    <a href="{{ project.project_youtube }}" target="_blank" class="project-link">
                                        <svg viewBox="0 0 24 24" width="18" height="18">
                                            <path fill="currentColor" d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                                        </svg>
                                        YouTube
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}

                    <!-- Owner Actions -->
                    {% if current_user.is_authenticated and current_user.id == project.user_id %}
                        <div class="owner-actions">
                            <a href="{{ url_for('projects.edit', id=project.id) }}" class="btn btn-outline btn-block">
                                Edit Project
                            </a>
                            {% if project.is_draft %}
                            <form action="{{ url_for('projects.publish', id=project.id) }}" method="POST">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-primary btn-block">
                                    Publish Project
                                </button>
                            </form>
                            {% elif project.donation_count == 0 %}
                            <form action="{{ url_for('projects.unpublish', id=project.id) }}" method="POST"
                                  onsubmit="return confirm('Are you sure you want to unpublish this project?')">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-outline btn-block">
                                    Unpublish (Make Draft)
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </aside>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Gallery functionality
document.querySelectorAll('.gallery-thumb').forEach(thumb => {
    thumb.addEventListener('click', () => {
        const image = thumb.dataset.image;
        document.getElementById('galleryMainImage').src = image;
        document.querySelectorAll('.gallery-thumb').forEach(t => t.classList.remove('active'));
        thumb.classList.add('active');
    });
});

// Amount presets
document.querySelectorAll('.preset-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const amount = btn.dataset.amount;
        document.getElementById('donationAmount').value = amount;
        document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updateUsdEstimate(amount);
    });
});

// USD estimate
let solPrice = null;
fetch('/api/sol-price')
    .then(r => r.json())
    .then(data => {
        solPrice = data.price_usd;
        updateUsdEstimate(document.getElementById('donationAmount').value);
    });

function updateUsdEstimate(solAmount) {
    const estimate = document.getElementById('usdEstimate');
    if (solPrice && solAmount) {
        const usd = (parseFloat(solAmount) * solPrice).toFixed(2);
        estimate.textContent = `≈ $${usd} USD`;
    }
}

document.getElementById('donationAmount').addEventListener('input', (e) => {
    updateUsdEstimate(e.target.value);
    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
});

// Share functionality
document.querySelectorAll('.share-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const shareType = btn.dataset.share;
        const url = window.location.href;
        const title = '{{ project.title }}';

        switch(shareType) {
            case 'twitter':
                window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(url)}`, '_blank');
                break;
            case 'telegram':
                window.open(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`, '_blank');
                break;
            case 'copy':
                navigator.clipboard.writeText(url).then(() => {
                    showToast('Link copied!', 'success');
                });
                break;
        }
    });
});

// Reward Tier Selection
const rewardTierCards = document.querySelectorAll('.reward-tier-card');
const selectedTierIdInput = document.getElementById('selectedTierId');
const donorEmailGroup = document.getElementById('donorEmailGroup');
const donationAmountInput = document.getElementById('donationAmount');

rewardTierCards.forEach(card => {
    card.addEventListener('click', () => {
        if (card.classList.contains('sold-out')) return;

        // Deselect all
        rewardTierCards.forEach(c => c.classList.remove('selected'));
        // Select this one
        card.classList.add('selected');

        const tierId = card.dataset.tierId;
        const minAmount = parseFloat(card.dataset.minAmount) || 0;

        if (selectedTierIdInput) {
            selectedTierIdInput.value = tierId;
        }

        // Show/hide email field
        if (donorEmailGroup) {
            donorEmailGroup.style.display = tierId ? 'block' : 'none';
        }

        // Update amount to minimum if current is lower
        if (minAmount > 0 && donationAmountInput) {
            const currentAmount = parseFloat(donationAmountInput.value) || 0;
            if (currentAmount < minAmount) {
                donationAmountInput.value = minAmount;
                // Trigger USD estimate update
                donationAmountInput.dispatchEvent(new Event('input'));
            }
        }
    });
});

// Donation consent checkbox
const donationConsent = document.getElementById('donationConsent');
const donateBtn = document.getElementById('donateBtn');

if (donationConsent && donateBtn) {
    donationConsent.addEventListener('change', () => {
        donateBtn.disabled = !donationConsent.checked;
    });
}

// Donate button
const donateButton = document.getElementById('donateBtn');

if (donateButton) {
    donateButton.addEventListener('click', async function(e) {
        const amount = document.getElementById('donationAmount').value;
        const message = document.getElementById('donationMessage').value;
        const projectId = {{ project.id }};
        const consent = document.getElementById('donationConsent');
        const tierId = selectedTierIdInput ? selectedTierIdInput.value : '';
        const donorEmail = document.getElementById('donorEmail')?.value || '';

        if (!consent || !consent.checked) {
            showToast('You must agree to the terms', 'error');
            return;
        }

        if (!amount || parseFloat(amount) <= 0) {
            showToast('Please enter a valid amount', 'error');
            return;
        }

        // Check minimum amount for selected tier
        const selectedTierCard = document.querySelector('.reward-tier-card.selected');
        if (selectedTierCard) {
            const minAmount = parseFloat(selectedTierCard.dataset.minAmount) || 0;
            if (parseFloat(amount) < minAmount) {
                showToast(`Minimum amount for this reward is ${minAmount} SOL`, 'error');
                return;
            }
        }

        // Require email if reward tier is selected
        if (tierId && !donorEmail) {
            showToast('Please enter your email for reward delivery', 'error');
            return;
        }

        try {
            await makeDonation(projectId, parseFloat(amount), message, tierId, donorEmail);
        } catch (error) {
            console.error('Donation error:', error);
        }
    });
}

// Comment reply toggle
document.querySelectorAll('.reply-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
        const commentId = btn.dataset.commentId;
        const form = document.getElementById(`reply-form-${commentId}`);
        if (form) {
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
            if (form.style.display === 'block') {
                form.querySelector('textarea').focus();
            }
        }
    });
});

// Reply cancel buttons
document.querySelectorAll('.reply-cancel').forEach(btn => {
    btn.addEventListener('click', () => {
        const form = btn.closest('.reply-form');
        if (form) {
            form.style.display = 'none';
            form.querySelector('textarea').value = '';
        }
    });
});
</script>
{% endblock %}
